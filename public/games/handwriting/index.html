<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœï¸ æ‰‹å†™æ±‰å­—å¤§å¸ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f7; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; color: #333; }
        .header-nav { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-link { text-decoration: none; color: #666; font-size: 0.9em; }
        select { padding: 10px 15px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; background: white; max-width: 70%; }
        
        /* æ¸¸æˆä¸»åŒºåŸŸ */
        .game-container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 500px; }
        #target-char-display { font-size: 2em; margin-bottom: 10px; color: #555; height: 1.2em; }
        
        /* æ±‰å­—ä¹¦å†™æ ¼åŒºåŸŸ */
        #character-target-div { 
            width: 300px; height: 300px; margin: 0 auto 30px auto; 
            border: 3px dashed #ddd; /* ç±³å­—æ ¼è¾¹æ¡† */
            background-image: 
                linear-gradient(45deg, transparent 49.5%, #eee 49.5%, #eee 50.5%, transparent 50.5%),
                linear-gradient(-45deg, transparent 49.5%, #eee 49.5%, #eee 50.5%, transparent 50.5%),
                linear-gradient(0deg, transparent 49.5%, #eee 49.5%, #eee 50.5%, transparent 50.5%),
                linear-gradient(90deg, transparent 49.5%, #eee 49.5%, #eee 50.5%, transparent 50.5%);
            background-size: 100% 100%;
            border-radius: 12px;
            cursor: crosshair; /* é¼ æ ‡å˜æˆåå­—å‡†æ˜Ÿ */
        }

        /* æŒ‰é’®ç»„ */
        .controls { display: flex; gap: 15px; justify-content: center; }
        button { padding: 12px 24px; border: none; border-radius: 10px; font-size: 18px; cursor: pointer; transition: 0.2s; font-weight: bold; }
        #retry-btn { background: #f0ad4e; color: white; }
        #next-btn { background: #4a90e2; color: white; }
        button:hover { opacity: 0.9; transform: scale(1.05); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        /* çŠ¶æ€æç¤º */
        #status-msg { height: 30px; margin-top: 15px; color: #28a745; font-weight: bold; }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
    </style>
</head>
<body>
    <div class="header-nav">
        <a href="/" class="back-link">â† å›åˆ°å¤§å…</a>
        <select id="episode-select" onchange="changeEpisode()">
            <option value="">åŠ è½½ä¸­...</option>
        </select>
    </div>

    <div class="game-container">
        <div id="target-char-display">å‡†å¤‡å¼€å§‹...</div>
        <div id="character-target-div"></div>
        
        <div class="controls">
            <button id="retry-btn" onclick="retryChar()">ğŸ”„ é‡å†™</button>
            <button id="next-btn" onclick="nextChar()" disabled>ä¸‹ä¸€å­— â¡ï¸</button>
        </div>
        <div id="status-msg"></div>
    </div>

    <script>
        const API_URL = '/api/handwriting-data';
        let episodes = [];
        let currentEpisodeData = null;
        let currentCharIndex = 0;
        let writer = null; // HanziWriter å®ä¾‹

        // 1. åˆå§‹åŒ–åŠ è½½æ•°æ®
        async function init() {
            const res = await fetch(API_URL);
            episodes = await res.json();
            const select = document.getElementById('episode-select');
            select.innerHTML = '';
            episodes.forEach((ep, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = ep.title;
                select.appendChild(option);
            });
            // é»˜è®¤åŠ è½½ç¬¬ä¸€é›†
            if (episodes.length > 0) {
                loadEpisode(0);
            }
        }

        // 2. åˆ‡æ¢é›†æ•°
        function changeEpisode() {
            const index = document.getElementById('episode-select').value;
            loadEpisode(index);
        }

        // 3. åŠ è½½æŸä¸€é›†çš„æ•°æ®
        function loadEpisode(index) {
            currentEpisodeData = episodes[index];
            currentCharIndex = 0;
            loadCharacter();
            document.getElementById('next-btn').disabled = true;
            document.getElementById('status-msg').innerText = '';
        }

        // 4. åŠ è½½å½“å‰æ±‰å­—åˆ°ç”»å¸ƒ
        function loadCharacter() {
            if (!currentEpisodeData || currentCharIndex >= currentEpisodeData.characters.length) {
                showFinish();
                return;
            }
            
            const char = currentEpisodeData.characters[currentCharIndex];
            document.getElementById('target-char-display').innerText = `å½“å‰ç»ƒä¹ ï¼š${char} (${currentCharIndex + 1}/${currentEpisodeData.characters.length})`;
            document.getElementById('character-target-div').innerHTML = ''; // æ¸…ç©ºæ—§çš„
            document.getElementById('status-msg').innerText = '';
            document.getElementById('next-btn').disabled = true;

            // --- Hanzi Writer æ ¸å¿ƒé…ç½® ---
            writer = HanziWriter.create('character-target-div', char, {
                width: 300,
                height: 300,
                padding: 20,
                showOutline: true, // æ˜¾ç¤ºè½®å»“æç¤º
                strokeAnimationSpeed: 1, // ç¬”ç”»æç¤ºé€Ÿåº¦
                delayBetweenStrokes: 200, // æç¤ºé—´éš”
                strokeColor: '#333', // ä¹¦å†™é¢œè‰²
                radicalColor: '#4a90e2', // éƒ¨é¦–é¢œè‰²ï¼ˆå¦‚æœæ”¯æŒï¼‰
                outlineColor: '#ddd', // è½®å»“é¢œè‰²
                drawingWidth: 20, // ç¬”è§¦ç²—ç»†
                showHintAfterMisses: 1, // å†™é”™1æ¬¡åæ˜¾ç¤ºæç¤º
                highlightOnComplete: true // å®Œæˆåé«˜äº®
            });

            // å¯åŠ¨æµ‹éªŒæ¨¡å¼
            startQuiz();
        }

        // 5. å¼€å§‹ä¹¦å†™æµ‹éªŒ
        function startQuiz() {
            writer.quiz({
                onMistake: function(strokeData) {
                    console.log('å†™é”™äº†ç¬”ç”»!');
                    document.getElementById('status-msg').innerText = 'ç¬”ç”»é¡ºåºæˆ–æ–¹å‘ä¸å¯¹å“¦ï¼Œå†è¯•è¯•ï¼';
                    document.getElementById('character-target-div').classList.add('shake');
                    setTimeout(() => document.getElementById('character-target-div').classList.remove('shake'), 500);
                },
                onCorrectStroke: function(strokeData) {
                    document.getElementById('status-msg').innerText = 'å¾ˆæ£’ï¼ç»§ç»­ï¼';
                },
                onComplete: function(summaryData) {
                    console.log('å®Œæˆæ¦‚å†µ:', summaryData);
                    document.getElementById('status-msg').innerText = `å¤ªæ£’äº†ï¼è¯„åˆ†: ${parseInt(summaryData.score * 100)}åˆ†ï¼`;
                    document.getElementById('next-btn').disabled = false;
                    // æ’­æ”¾æˆåŠŸåŠ¨ç”»
                    setTimeout(() => {
                        writer.animateCharacter({ loop: false });
                    }, 500);
                }
            });
        }

        // 6. æŒ‰é’®æ“ä½œ
        function retryChar() {
            document.getElementById('status-msg').innerText = '';
            // é‡æ–°å¼€å§‹æµ‹éªŒåŠ¨ç”»
            startQuiz();
        }

        function nextChar() {
            currentCharIndex++;
            loadCharacter();
        }

        // 7. æ˜¾ç¤ºå®Œæˆç•Œé¢
        function showFinish() {
            document.getElementById('target-char-display').innerText = "ğŸ‰ æœ¬é›†ç»ƒä¹ å®Œæˆï¼";
            document.getElementById('character-target-div').innerHTML = '<div style="font-size:5em; line-height:300px;">âœ…</div>';
            document.getElementById('retry-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('status-msg').innerText = "çœŸå‰å®³ï¼Œå»é€‰ä¸‹ä¸€é›†å§ï¼";
        }

        init();
    </script>
</body>
</html>