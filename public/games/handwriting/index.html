<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¦ŠğŸ° ç–¯ç‹‚åŠ¨ç‰©åŸï¼šæ±‰å­—å¤§å†’é™© (ç”µå½±ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700;800&family=Zcool+KuaiLe&display=swap" rel="stylesheet">
    <style>
        :root {
            --theme-color: #004e92;
            --accent-color: #00c6ff;
            --text-color: #fff;
            /* é¢æ¿èƒŒæ™¯ç¨å¾®é€æ˜ä¸€ç‚¹ï¼Œé€å‡ºåé¢çš„åœºæ™¯ */
            --panel-bg: rgba(255, 255, 255, 0.85);
            /* é®ç½©å±‚æ·±åº¦ï¼Œæ•°å€¼è¶Šå¤§èƒŒæ™¯è¶Šæš—ï¼Œå‰æ™¯è¶Šæ¸…æ™° */
            --overlay-opacity: 0.4; 
        }

        body {
            font-family: 'Baloo 2', 'Zcool KuaiLe', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #333; /* å›¾ç‰‡åŠ è½½å‰çš„åº•è‰² */
        }

        /* --- æ²‰æµ¸å¼èƒŒæ™¯å±‚ (æ˜¾ç¤ºç”µå½±å›¾ç‰‡) --- */
        #bg-image {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            /* é»˜è®¤å›¾ç‰‡ï¼Œä¼šè¢«JSæ›¿æ¢ */
            background-image: url('https://via.placeholder.com/1920x1080/004e92/ffffff?text=Zootopia+Loading...');
            background-size: cover; /* ä¿è¯å›¾ç‰‡é“ºæ»¡å±å¹• */
            background-position: center center;
            z-index: -10;
            transition: background-image 0.5s ease-in-out; /* å›¾ç‰‡åˆ‡æ¢æ—¶çš„è¿‡æ¸¡ */
        }

        /* --- èƒŒæ™¯é®ç½©å±‚ (è®©èƒŒæ™¯å˜æš—ï¼Œçªå‡ºå‰æ™¯) --- */
        #bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0, var(--overlay-opacity));
            z-index: -9;
            pointer-events: none;
        }

        /* --- é¡¶éƒ¨å¯¼èˆª --- */
        .top-bar {
            position: absolute; top: 20px; left: 0; width: 100%;
            display: flex; justify-content: space-between; padding: 0 20px;
            box-sizing: border-box; z-index: 10;
        }
        
        .back-btn {
            background: rgba(0,0,0,0.5); color: white; padding: 8px 15px;
            border-radius: 20px; text-decoration: none; font-weight: bold;
            border: 2px solid rgba(255,255,255,0.4); backdrop-filter: blur(10px);
            transition: 0.2s;
        }
        .back-btn:hover { background: rgba(255,255,255,0.2); }

        .scene-selector {
            background: rgba(255,255,255,0.9); border: 3px solid var(--theme-color); padding: 8px 15px;
            border-radius: 20px; font-weight: bold; color: var(--theme-color); cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); outline: none;
        }

        /* --- æ¸¸æˆä¸»èˆå° --- */
        .stage-container {
            position: relative;
            background: var(--panel-bg);
            /* å¢åŠ æ¯›ç»ç’ƒæ•ˆæœï¼Œæ›´æœ‰è´¨æ„Ÿ */
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px);
            padding: 25px;
            border-radius: 35px;
            /* å‘å…‰è¾¹æ¡† */
            border: 4px solid var(--theme-color);
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.6), /* æ·±é‡æŠ•å½± */
                inset 0 0 20px rgba(255,255,255,0.5); /* å†…å‘å…‰ */
            text-align: center;
            width: 340px;
            transition: transform 0.3s, border-color 0.5s;
            z-index: 5;
        }

        .char-info {
            font-size: 1.5em; margin-bottom: 15px; color: var(--theme-color); font-weight: 800;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
        }

        #character-target-div { 
            width: 300px; height: 300px; margin: 0 auto;
            border: 3px solid var(--theme-color); border-radius: 25px;
            background: rgba(255,255,255,0.9); cursor: crosshair; position: relative;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.1);
        }
        /* ç±³å­—æ ¼ */
        #character-target-div::before, #character-target-div::after {
            content: ''; position: absolute; background: var(--theme-color); opacity: 0.3;
        }
        #character-target-div::before { top: 50%; left: 0; width: 100%; height: 2px; }
        #character-target-div::after { left: 50%; top: 0; height: 100%; width: 2px; }

        /* æŒ‰é’®ç»„ */
        .controls { display: flex; gap: 15px; justify-content: center; margin-top: 25px; }
        .game-btn {
            padding: 12px 24px; border: none; border-radius: 50px;
            font-size: 18px; font-weight: bold; color: white; cursor: pointer;
            font-family: 'Baloo 2'; transition: all 0.2s;
            box-shadow: 0 6px 0 rgba(0,0,0,0.3), 0 15px 20px rgba(0,0,0,0.2);
            border: 2px solid white;
        }
        .game-btn:active { transform: translateY(6px); box-shadow: none; }
        .btn-retry { background: #ff6f00; /* å°¼å…‹æ©™å›ºå®š */ }
        .btn-next { background: var(--theme-color); /* è·Ÿéšåœºæ™¯å˜è‰² */ }
        .btn-disabled { background: #95a5a6; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }

        /* --- NPC äº’åŠ¨è§’è‰²å±‚ --- */
        .npc-container {
            position: fixed; bottom: 0; right: -10px;
            width: auto; height: auto; z-index: 20;
            pointer-events: none;
        }

        .npc-avatar {
            font-size: 9em; /* Emojiå¤§å° */
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
            animation: breathe 3s infinite ease-in-out;
            transform-origin: bottom center;
        }
        
        /* å¦‚æœä½ æƒ³ç”¨çœŸå®å›¾ç‰‡ä»£æ›¿Emojiï¼Œå–æ¶ˆä¸‹é¢æ³¨é‡Šå¹¶è®¾ç½®å›¾ç‰‡URL */
        /*
        .npc-image {
            height: 300px; width: auto;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
        }
        */

        /* å¯¹è¯æ°”æ³¡ */
        .speech-bubble {
            position: absolute; bottom: 200px; right: 60px;
            background: white; padding: 18px 24px; border-radius: 30px 30px 5px 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            font-size: 17px; font-weight: bold; color: #2c3e50;
            width: 200px; opacity: 0; transform: scale(0.8) translateY(20px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto; border: 3px solid var(--theme-color);
        }
        .speech-bubble.show { opacity: 1; transform: scale(1) translateY(0); }
        

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes breathe { 0%, 100% { transform: scale(1) rotate(-2deg); } 50% { transform: scale(1.05) rotate(2deg); } }
        @keyframes jump { 0% { transform: translateY(0); } 30% { transform: translateY(-40px) scale(1.1); } 100% { transform: translateY(0); } }
        .jump-anim { animation: jump 0.6s; }
        .shake-anim { animation: shake 0.5s both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-3px, 0, 0); } 20%, 80% { transform: translate3d(6px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-9px, 0, 0); } 40%, 60% { transform: translate3d(9px, 0, 0); } }

        @media (max-width: 600px) {
            .stage-container { transform: scale(0.85) translateY(-30px); }
            .npc-avatar { font-size: 7em; right: 0; }
            .speech-bubble { bottom: 160px; right: 30px; width: 160px; font-size: 15px; }
        }
    </style>
</head>
<body>

    <div id="bg-image"></div>
    <div id="bg-overlay"></div>

    <div class="top-bar">
        <a href="/" class="back-btn">â¬… å¤§å…</a>
        <div style="display:flex; gap:10px;">
            <select id="episode-select" class="scene-selector" onchange="changeEpisode()">
                <option>åŠ è½½ä¸­...</option>
            </select>
            <select id="scene-select" class="scene-selector" onchange="manualChangeScene()">
                <option value="0">ğŸ™ï¸ å¸‚ä¸­å¿ƒ</option>
                <option value="1">ğŸ© ç”œç”œåœˆåº—</option>
                <option value="2">ğŸ‘® è­¦å±€å‰å°</option>
                <option value="3">â„ï¸ æåœ°åŒº</option>
                <option value="4">ğŸƒ é›¨æ—åŒº</option>
                <option value="5">ğŸ¥• å…”çªé•‡</option>
                <option value="6">ğŸ­ å•®é½¿åŠ¨ç‰©åŸ</option>
                <option value="7">ğŸ¦¥ è½¦ç®¡æ‰€</option>
                <option value="8">ğŸ¤ æ¼”å”±ä¼š</option>
                <option value="9">ğŸ¦ å¸‚é•¿åŠå…¬å®¤</option>
            </select>
        </div>
    </div>

    <div class="stage-container">
        <div id="char-info-display" class="char-info">å‡†å¤‡ä¸­...</div>
        <div id="character-target-div"></div>
        <div class="controls">
            <button id="retry-btn" class="game-btn btn-retry" onclick="retryChar()">é‡å†™</button>
            <button id="next-btn" class="game-btn btn-next" onclick="nextChar()" disabled>ä¸‹ä¸€å­—</button>
        </div>
    </div>

    <div class="npc-container">
        <div id="npc-bubble" class="speech-bubble">ä½ å¥½å‘€ï¼æˆ‘æ˜¯æœ±è¿ªè­¦å®˜ï¼Œå‡†å¤‡å¥½å¼€å§‹æŒ‘æˆ˜äº†å—ï¼Ÿ</div>
        <div id="npc-avatar" class="npc-avatar">ğŸ°</div>
    </div>

    <script>
        // =============== æ ¸å¿ƒé…ç½®åŒº (è¯·æ›¿æ¢å›¾ç‰‡é“¾æ¥) ===============
        // æç¤ºï¼šä½ å¯ä»¥å»ç½‘ä¸Šæ‰¾å›¾ï¼Œæˆ–è€…æŠŠå›¾ç‰‡æ”¾åˆ°é¡¹ç›®çš„ public/img ç›®å½•ä¸‹ï¼Œç„¶åç”¨ '/img/city.jpg' è¿™æ ·çš„è·¯å¾„
        const SCENES = [
            {   // 0. å¸‚ä¸­å¿ƒ
                bgImg: 'url("/img/1.png")', 
                theme: '#004e92', char: 'ğŸ°', role: 'æœ±è¿ª',
                msgs: { start: 'æˆ‘æ˜¯æœ±è¿ªï¼å¸‚ä¸­å¿ƒäººå¾ˆå¤šï¼Œå†™å­—è¦ä¸“å¿ƒå“¦ï¼', good: 'å“‡ï¼åƒç ´æ¡ˆä¸€æ ·ç²¾å‡†ï¼', bad: 'åˆ«æ€¥ï¼Œæˆ‘ä»¬è­¦å¯Ÿæœ€è®²ç©¶è€å¿ƒï¼', done: 'ä»»åŠ¡å®Œæˆï¼ä½ å¯ä»¥åŠ å…¥ ZPD äº†ï¼' }
            },
            {   // 1. ç”œç”œåœˆåº—
                bgImg: 'url("ã€è¯·æ›¿æ¢æˆä½ çš„ç”œç”œåœˆåº—æˆ–å°¼å…‹å›¾ç‰‡é“¾æ¥ã€‘")', 
                theme: '#ff6f00', char: 'ğŸ¦Š', role: 'å°¼å…‹',
                msgs: { start: 'å˜¿å°å®¶ä¼™ï¼Œæ¥æ ¹å†°æ£å‰å…ˆå†™ä¸ªå­—çœ‹çœ‹ã€‚', good: 'å‘¦ï¼Œè¿˜ä¸èµ–å˜›ï¼ç‹¡çŒ¾çš„æ“ä½œã€‚', bad: 'å“å‘€éœ²é¦…äº†ï¼Œæ˜¯ä¸æ˜¯æƒ³åƒç”œç”œåœˆåˆ†å¿ƒäº†ï¼Ÿ', done: 'å¹²å¾—æ¼‚äº®ï¼è¿™æ ¹çˆªçˆªå†°æ£å…è´¹é€ä½ ã€‚' }
            },
            {   // 2. è­¦å±€å‰å°
                bgImg: 'url("ã€è¯·æ›¿æ¢æˆä½ çš„è­¦å±€å‰å°å›¾ç‰‡é“¾æ¥ã€‘")', 
                theme: '#005b9f', char: 'ğŸ†', role: 'è±¹è­¦å®˜',
                msgs: { start: 'å“¦å¤©å“ªï¼é™¤äº†ç”œç”œåœˆï¼Œæˆ‘æœ€çˆ±çš„å°±æ˜¯çœ‹äººå†™å­—ï¼', good: 'å“‡ï¼è¿™ä¸ªå­—æ¯”æˆ‘çš„è„¸è¿˜è¦åœ†æ¶¦å¯çˆ±ï¼', bad: 'å“¦ä¸ï¼Œè¿™ç¬”ç”»æ­ªäº†ï¼Œåƒè¢«å’¬äº†ä¸€å£çš„ç”œåœˆã€‚', done: 'å¤ªå¸…äº†ï¼æˆ‘è¦åœ¨è¿™ä¸ªå­—æ—è¾¹è·³ä¸ªèˆåº†ç¥ï¼' }
            },
            {   // 3. æåœ°åŒº
                bgImg: 'url("ã€è¯·æ›¿æ¢æˆä½ çš„æåœ°åŒºæˆ–å¤§å…ˆç”Ÿå›¾ç‰‡é“¾æ¥ã€‘")', 
                theme: '#2c3e50', char: 'ğŸ»â€â„ï¸', role: 'å¤§å…ˆç”Ÿ',
                msgs: { start: 'è¿™æ˜¯æˆ‘çš„åœ°ç›˜ã€‚å±•ç¤ºä½ çš„å°Šé‡ï¼Œå†™å¥½å®ƒã€‚', good: 'è¿™è¿˜å·®ä¸å¤šã€‚æœ‰ç‚¹æ•™çˆ¶çš„é£èŒƒã€‚', bad: 'è¿™æ˜¯å¯¹æˆ‘çš„ä¸æ•¬å—ï¼Ÿå†°å†»ä»–ï¼(å¼€ç©ç¬‘çš„é‡å†™)', done: 'å¾ˆå¥½ã€‚ä½ ç°åœ¨æ˜¯æˆ‘ä»¬å®¶æ—çš„ä¸€å‘˜äº†ã€‚' }
            },
            {   // 4. é›¨æ—åŒº
                bgImg: 'url("ã€è¯·æ›¿æ¢æˆä½ çš„é›¨æ—åŒºå›¾ç‰‡é“¾æ¥ã€‘")', 
                theme: '#00695c', char: 'ğŸ†', role: 'æ›¼æŸ¥æ–¯',
                msgs: { start: 'é›¨æ—é‡Œå¾ˆæ¹¿æ»‘ï¼Œæ¡ç´§ä½ çš„ç¬”ï¼Œå°å¿ƒåˆ«æ‰ä¸‹å»ã€‚', good: 'è¡Œäº‘æµæ°´ï¼Œåƒè—¤è”“ä¸€æ ·è‡ªç„¶ç”Ÿé•¿ã€‚', bad: 'å°å¿ƒï¼åˆ«æ»‘å€’äº†ï¼è¿™ç¬”ç”»æ–­äº†ã€‚', done: 'ä½ å¾æœäº†è¿™ç‰‡ä¸›æ—ï¼æ˜¯ä¸ªå‹‡æ•¢çš„æ¢é™©å®¶ï¼' }
            },
            {   // 5. å…”çªé•‡
                bgImg: 'url("ã€è¯·æ›¿æ¢æˆä½ çš„å…”çªé•‡å†œåœºå›¾ç‰‡é“¾æ¥ã€‘")', 
                theme: '#7cb342', char: 'ğŸ‡', role: 'é‚¦å°¼å¦ˆå¦ˆ',
                msgs: { start: 'ä¹–å­©å­ï¼Œç§èƒ¡èåœå’Œå†™å­—ä¸€æ ·ï¼Œéƒ½è¦å‹¤å¥‹å“¦ã€‚', good: 'ç§å¾—...å“¦ä¸ï¼Œå†™å¾—çœŸå¥½ï¼çœŸæ•´é½ï¼', bad: 'æ²¡å…³ç³»å®è´ï¼Œæˆ‘ä»¬å…”å­å®¶æœ€ä¸æ€•å¤±è´¥äº†ï¼Œå†è¯•ä¸€æ¬¡ã€‚', done: 'æ— è®ºä½ å†™å¾—æ€æ ·ï¼Œå¦ˆå¦ˆæ°¸è¿œéƒ½ä¸ºä½ éª„å‚²ï¼' }
            },
            {   // 6. å•®é½¿åŠ¨ç‰©åŸ
                bgImg: 'url("ã€è¯·æ›¿æ¢æˆä½ çš„å°äººå›½å›¾ç‰‡é“¾æ¥ã€‘")', 
                theme: '#e91e63', char: 'ğŸ­', role: 'éœ²éœ²',
                msgs: { start: 'åˆ«çœ‹æˆ‘å°ï¼Œæˆ‘å¯¹å­—çš„è¦æ±‚å¯æ˜¯éå¸¸ç²¾è‡´çš„ï¼', good: 'ç²¾è‡´ï¼ä¼˜é›…ï¼å®Œç¾ï¼å°±åƒæˆ‘çš„å©šçº±ä¸€æ ·ï¼', bad: 'å¤ªå¤§äº†ï¼å¤ªç²—é²äº†ï¼å°å¿ƒåˆ«è¸©åäº†èŠ±è‰ï¼', done: 'æˆ‘æ­£å¼é‚€è¯·ä½ æ¥å‚åŠ æˆ‘çš„å©šç¤¼å½“èŠ±ç«¥ï¼' }
            },
            {   // 7. è½¦ç®¡æ‰€
                bgImg: 'url("ã€è¯·æ›¿æ¢æˆä½ çš„è½¦ç®¡æ‰€é—ªç”µå›¾ç‰‡é“¾æ¥ã€‘")', 
                theme: '#546e7a', char: 'ğŸ¦¥', role: 'é—ªç”µ',
                // é—ªç”µè¯´è¯è¦æœ‰ç‰¹è‰²
                msgs: { start: 'å¼€......å§‹......å†™......äº†......å—......ï¼Ÿ', good: 'å†™......å¾—......å¥½......å¿«......å•Š......', bad: 'ä½ ......è¿™......é‡Œ......é”™......äº†......', done: 'å“ˆ......å“ˆ......å“ˆ......å“ˆ......' }
            },
            {   // 8. æ¼”å”±ä¼š
                bgImg: 'url("ã€è¯·æ›¿æ¢æˆä½ çš„å¤å¥‡ç¾Šæ¼”å”±ä¼šå›¾ç‰‡é“¾æ¥ã€‘")', 
                theme: '#d500f9', char: 'ç¾š', role: 'å¤å¥‡ç¾Š',
                msgs: { start: 'å¤§å®¶ä¸€èµ·è·³èµ·æ¥ï¼è®©ä½ çš„ç¬”å°–è·Ÿç€èŠ‚å¥èˆåŠ¨ï¼', good: 'ä½ çš„å­—åœ¨å‘å…‰ï¼Try Everything!', bad: 'åˆ«æ”¾å¼ƒï¼å†è¯•ä¸€æ¬¡ï¼å°±åƒæ­Œé‡Œå”±çš„é‚£æ ·ï¼', done: 'ä½ æ˜¯ä»Šæ™šæœ€è€€çœ¼çš„æ˜æ˜Ÿï¼è°¢è°¢å¤§å®¶ï¼' }
            },
            {   // 9. å¸‚é•¿åŠå…¬å®¤
                bgImg: 'url("ã€è¯·æ›¿æ¢æˆä½ çš„å¸‚é•¿åŠå…¬å®¤å›¾ç‰‡é“¾æ¥ã€‘")', 
                theme: '#bf360c', char: 'ğŸ¦', role: 'ç‹®å¸‚é•¿',
                msgs: { start: 'ä¸ºäº†åŠ¨ç‰©åŸçš„è£è€€ï¼å¸‚æ°‘ä»¬ï¼Œå†™å¥½è¿™ä¸ªå­—ï¼', good: 'è¿™å°±æ˜¯é¢†è¢–çš„é£èŒƒï¼éå¸¸æœ‰æ°”åŠ¿ï¼', bad: 'è¿™å¯ä¸è¡Œï¼Œè¿™ä¸ç¬¦åˆå¸‚æ”¿æ ‡å‡†ï¼é‡æ¥ï¼', done: 'æˆ‘å®£å¸ƒï¼Œæˆäºˆä½ â€œåŠ¨ç‰©åŸå¹´åº¦æœ€ä½³ä¹¦å†™å‘˜â€å‹‹ç« ï¼' }
            },
        ];

        // =============== ä¸šåŠ¡é€»è¾‘åŒº ===============
        const API_URL = '/api/handwriting-data';
        let episodes = [];
        let currentEpisodeData = null;
        let currentCharIndex = 0;
        let writer = null;
        let currentSceneIdx = 0;

        async function init() {
            try {
                const res = await fetch(API_URL);
                episodes = await res.json();
                const select = document.getElementById('episode-select');
                select.innerHTML = '';
                if(episodes.length === 0) { select.innerHTML = '<option>æš‚æ— æ•°æ®</option>'; return; }
                episodes.forEach((ep, index) => {
                    const opt = document.createElement('option'); opt.value = index; opt.text = ep.title; select.appendChild(opt);
                });
                
                // éšæœºå¼€å§‹ä¸€ä¸ªåœºæ™¯
                currentSceneIdx = Math.floor(Math.random() * SCENES.length);
                document.getElementById('scene-select').value = currentSceneIdx;
                applyScene(currentSceneIdx);
                loadEpisode(0);
            } catch(e) { console.error(e); }
        }

        function applyScene(idx) {
            currentSceneIdx = idx;
            const scene = SCENES[idx];
            
            // 1. åˆ‡æ¢èƒŒæ™¯å›¾ç‰‡
            document.getElementById('bg-image').style.backgroundImage = scene.bgImg;
            
            // 2. æ›´æ–°ä¸»é¢˜è‰²å˜é‡
            document.documentElement.style.setProperty('--theme-color', scene.theme);
            
            // 3. æ›´æ–°è§’è‰² (Emoji æˆ– å›¾ç‰‡)
            const avatar = document.getElementById('npc-avatar');
            avatar.innerText = scene.char; 
            // å¦‚æœä½ ç”¨å›¾ç‰‡ï¼Œæ”¹æˆ: avatar.innerHTML = `<img src="${scene.charImgUrl}" class="npc-image">`;

            avatar.classList.remove('jump-anim'); void avatar.offsetWidth; avatar.classList.add('jump-anim');
            showBubble(scene.msgs.start);
        }

        function manualChangeScene() {
            const idx = document.getElementById('scene-select').value;
            applyScene(idx);
        }
        
        function changeEpisode() { loadEpisode(document.getElementById('episode-select').value); }

        function loadEpisode(index) {
            currentEpisodeData = episodes[index]; currentCharIndex = 0; loadCharacter();
        }

        function loadCharacter() {
            const scene = SCENES[currentSceneIdx];
            if (!currentEpisodeData || currentCharIndex >= currentEpisodeData.characters.length) { showFinish(); return; }
            const char = currentEpisodeData.characters[currentCharIndex];
            
            document.getElementById('char-info-display').innerHTML = `
                <span style="font-size:0.8em; opacity:0.8;">ä»»åŠ¡:</span> ${char} 
                <span style="font-size:0.5em; opacity:0.6;">(${currentCharIndex+1}/${currentEpisodeData.characters.length})</span>
            `;
            document.getElementById('character-target-div').innerHTML = '';
            const nextBtn = document.getElementById('next-btn');
            nextBtn.disabled = true; nextBtn.classList.add('btn-disabled');

            writer = HanziWriter.create('character-target-div', char, {
                width: 300, height: 300, padding: 25, showOutline: true, strokeAnimationSpeed: 1.5, delayBetweenStrokes: 150,
                strokeColor: '#333', radicalColor: scene.theme, outlineColor: '#ddd', drawingWidth: 25,
                showHintAfterMisses: 1, highlightOnComplete: true, highlightColor: scene.theme
            });
            
            writer.quiz({
                onMistake: () => { showBubble(scene.msgs.bad); shakeScreen(); },
                onCorrectStroke: () => { if(Math.random() > 0.7) showBubble(scene.msgs.good); },
                onComplete: () => {
                    showBubble(scene.msgs.done);
                    nextBtn.disabled = false; nextBtn.classList.remove('btn-disabled');
                    const avatar = document.getElementById('npc-avatar');
                    avatar.classList.remove('jump-anim'); void avatar.offsetWidth; avatar.classList.add('jump-anim');
                    setTimeout(() => writer.animateCharacter(), 500);
                }
            });
        }

        let bubbleTimer;
        function showBubble(text) {
            const bubble = document.getElementById('npc-bubble');
            bubble.innerText = text; bubble.classList.add('show');
            clearTimeout(bubbleTimer); bubbleTimer = setTimeout(() => { bubble.classList.remove('show'); }, 3500);
        }

        function shakeScreen() {
            const stage = document.querySelector('.stage-container');
            stage.classList.add('shake-anim'); setTimeout(() => stage.classList.remove('shake-anim'), 500);
        }

        function retryChar() { showBubble('åŠ æ²¹ï¼å†è¯•ä¸€æ¬¡ï¼'); loadCharacter(); }

        function nextChar() {
            currentCharIndex++;
            // å¯é€‰ï¼šæ¯å†™ä¸€ä¸ªå­—éšæœºæ¢åœºæ™¯
            // const nextScene = Math.floor(Math.random() * SCENES.length);
            // document.getElementById('scene-select').value = nextScene; applyScene(nextScene);
            loadCharacter();
        }

        function showFinish() {
            document.getElementById('char-info-display').innerText = "ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼";
            document.getElementById('character-target-div').innerHTML = `<div style="height:100%; display:flex; justify-content:center; align-items:center; font-size:6em;">ğŸ‰ğŸ†</div>`;
            showBubble('å¤ªæ£’äº†ï¼ä½ çœŸæ˜¯åŠ¨ç‰©åŸçš„éª„å‚²ï¼å¿«å»å‘Šè¯‰å¤§å®¶ï¼');
        }

        init();
    </script>
</body>
</html>