<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ‰ å¦™ç¬”ç”ŸèŠ±ï¼šå›½é£æ±‰å­—å¤§å†’é™©</title>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zcool+KuaiLe&family=Noto+Serif+SC:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --theme-color: #333;
            --accent-color: #c0392b;
            --panel-bg: rgba(255, 255, 255, 0.9);
            --text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        body {
            /* ä½¿ç”¨æ›´æœ‰è¡¬çº¿æ„Ÿçš„å­—ä½“ */
            font-family: 'Noto Serif SC', 'Zcool KuaiLe', serif;
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #333;
        }

        /* --- åŠ¨æ€èƒŒæ™¯å±‚ (CSS åŠ¨ç”») --- */
        #bg-dynamic {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -20; background-size: 400% 400%;
            transition: opacity 0.8s ease;
        }

        /* --- ç²’å­åŠ¨ç”»ç”»å¸ƒå±‚ (Canvas) --- */
        #particle-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -15; pointer-events: none;
        }

        /* --- èƒŒæ™¯é®ç½©å±‚ (å¢åŠ è´¨æ„Ÿ) --- */
        #bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            /* å åŠ ä¸€å±‚å®£çº¸çº¹ç†æˆ–å™ªç‚¹ï¼Œå¢åŠ å¤æœ´æ„Ÿ */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 250 250' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='2' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.1'/%3E%3C/svg%3E");
            background-color: rgba(255,255,255, 0.1);
            z-index: -10; pointer-events: none; mix-blend-mode: overlay;
        }

        /* ====== åŠ¨æ€èƒŒæ™¯é£æ ¼å®šä¹‰ ====== */
        /* 1. æ°´å¢¨é£æ ¼ */
        .bg-ink {
            background: linear-gradient(135deg, #e0e0e0 0%, #ffffff 50%, #9e9e9e 100%);
            filter: contrast(1.2) grayscale(1);
            animation: flowInk 20s ease infinite alternate;
        }
        @keyframes flowInk { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }

        /* 2. æš–é˜³/èŠ‚åº†é£æ ¼ */
        .bg-festive {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        /* 3. ç«¹æ—/é’ç»¿å±±æ°´é£æ ¼ */
        .bg-nature {
            background: linear-gradient(to bottom, #d7d2cc 0%, #304352 100%);
            background: linear-gradient(135deg, #134E5E 0%, #71B280 100%);
            animation: breatheNature 10s ease-in-out infinite alternate;
        }
        @keyframes breatheNature { 0% { filter: brightness(1); } 100% { filter: brightness(1.1) hue-rotate(10deg); } }

        /* 4. ç´«æ°”ä¸œæ¥é£æ ¼ */
        .bg-purple {
            background: linear-gradient(to right, #6a11cb 0%, #2575fc 100%);
            opacity: 0.8;
            animation: driftClouds 30s linear infinite;
        }
        @keyframes driftClouds { from { background-position: 0 0; } to { background-position: 100% 0; } }


        /* --- UI å…ƒç´ è°ƒæ•´ (æ›´å¤æœ´) --- */
        .top-bar {
            position: absolute; top: 20px; left: 0; width: 100%;
            display: flex; justify-content: space-between; padding: 0 30px;
            box-sizing: border-box; z-index: 10;
        }
        
        .back-btn {
            background: rgba(51, 51, 51, 0.8); color: #e0d6c3; padding: 10px 20px;
            border-radius: 4px; text-decoration: none; font-weight: bold;
            border: 2px solid #c0392b; /* ä¸­å›½çº¢è¾¹æ¡† */
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: 0.2s;
        }
        .back-btn:hover { background: #c0392b; color: white; }

        .scene-selector {
            background: rgba(255,255,255,0.9); border: 3px solid var(--theme-color); padding: 8px 15px;
            border-radius: 4px; font-weight: bold; color: var(--theme-color); cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); outline: none; font-family: 'Noto Serif SC';
        }

        /* --- æ¸¸æˆä¸»èˆå° (å·è½´/å®£çº¸è´¨æ„Ÿ) --- */
        .stage-container {
            position: relative;
            background: var(--panel-bg);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d4c6b0' fill-opacity='0.1'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zM32 63c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm57-13c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z'/%3E%3C/g%3E%3C/svg%3E");
            padding: 30px;
            border-radius: 8px;
            /* åŒé‡è¾¹æ¡†ï¼Œæ¨¡æ‹Ÿè£…è£± */
            border: 6px double var(--theme-color);
            box-shadow: 0 20px 60px rgba(0,0,0,0.6), inset 0 0 30px rgba(230, 220, 200, 0.5);
            text-align: center;
            width: 360px;
            transition: transform 0.3s, border-color 0.5s;
            z-index: 5;
        }

        .char-info {
            font-size: 1.6em; margin-bottom: 20px; color: var(--theme-color); font-weight: bold;
            text-shadow: var(--text-shadow);
        }

        #character-target-div { 
            width: 300px; height: 300px; margin: 0 auto;
            border: 3px solid var(--theme-color); border-radius: 4px;
            background: rgba(255,255,255,0.95); cursor: crosshair; position: relative;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.1);
        }
        /* ç±³å­—æ ¼ (é¢œè‰²åŠ æ·±) */
        #character-target-div::before, #character-target-div::after {
            content: ''; position: absolute; background: var(--theme-color); opacity: 0.5;
        }
        #character-target-div::before { top: 50%; left: 0; width: 100%; height: 1px; }
        #character-target-div::after { left: 50%; top: 0; height: 100%; width: 1px; }

        /* æŒ‰é’®ç»„ (å°ç« é£æ ¼) */
        .controls { display: flex; gap: 20px; justify-content: center; margin-top: 30px; }
        .game-btn {
            padding: 12px 30px; border: none; border-radius: 4px;
            font-size: 20px; font-weight: bold; color: #e0d6c3; cursor: pointer;
            font-family: 'Noto Serif SC'; transition: all 0.2s;
            box-shadow: 0 6px 10px rgba(0,0,0,0.3);
            border: 3px solid #e0d6c3; /* æè¾¹ */
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
        }
        .game-btn:active { transform: translateY(4px); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .btn-retry { background: #c0392b; /* ä¸­å›½çº¢ */ }
        .btn-next { background: var(--theme-color); }
        .btn-disabled { background: #7f8c8d; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.8; border-color: #bdc3c7;}

        /* --- NPC äº’åŠ¨ (å°ç« /ç¥¥äº‘) --- */
        .npc-container {
            position: fixed; bottom: 20px; right: 20px;
            width: auto; height: auto; z-index: 20; pointer-events: none;
        }
        .npc-avatar {
            font-size: 8em; 
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.4));
            animation: floatAnim 4s infinite ease-in-out;
            opacity: 0.9;
        }
        
        /* å¯¹è¯æ°”æ³¡ (å·è½´é£æ ¼) */
        .speech-bubble {
            position: absolute; bottom: 180px; right: 80px;
            background: #fffcf5; padding: 20px 25px; border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            font-size: 18px; font-weight: bold; color: #5d4037;
            width: 220px; opacity: 0; transform: scale(0.8) translateY(20px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto; border: 4px double var(--theme-color);
            font-family: 'Noto Serif SC';
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d4c6b0' fill-opacity='0.1'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7z'/%3E%3C/g%3E%3C/svg%3E");
        }
        .speech-bubble.show { opacity: 1; transform: scale(1) translateY(0); }

        @keyframes floatAnim { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .shake-anim { animation: shake 0.5s both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-3px, 0, 0); } 20%, 80% { transform: translate3d(6px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-9px, 0, 0); } 40%, 60% { transform: translate3d(9px, 0, 0); } }
        @media (max-width: 600px) {
            .stage-container { transform: scale(0.85) translateY(-30px); }
            .npc-avatar { font-size: 6em; right: 0; }
            .speech-bubble { bottom: 140px; right: 40px; width: 180px; font-size: 16px; }
        }
    </style>
</head>
<body>

    <div id="bg-dynamic" class="bg-ink"></div>
    <canvas id="particle-canvas"></canvas>
    <div id="bg-overlay"></div>

    <div class="top-bar">
        <a href="/" class="back-btn">â¬… è¿”å›å¤§å…</a>
        <div style="display:flex; gap:10px;">
            <select id="episode-select" class="scene-selector" onchange="changeEpisode()">
                <option>æ­£åœ¨å±•å·...</option>
            </select>
            <select id="scene-select" class="scene-selector" onchange="manualChangeScene()">
                <option value="0">ğŸ”ï¸ æ°´å¢¨ä¸¹é’</option>
                <option value="1">ğŸŒ¸ è½è‹±ç¼¤çº·</option>
                <option value="2">ğŸ‹ ç«¹æ—æ¸…é£</option>
                <option value="3">ğŸ® å¤§å”ç››ä¸–</option>
                <option value="4">ğŸº é’èŠ±ç“·éŸµ</option>
                <option value="5">â˜ï¸ ç¥¥äº‘ç‘æ°”</option>
                <option value="6">ğŸ“œ é‡‘æ¦œé¢˜å</option>
                <option value="7">ğŸŒ™ è·å¡˜æœˆè‰²</option>
                <option value="8">ğŸ‚ ç§‹é£è½å¶</option>
                <option value="9">ğŸ”¥ è–ªç«ç›¸ä¼ </option>
            </select>
        </div>
    </div>

    <div class="stage-container">
        <div id="char-info-display" class="char-info">å‡†å¤‡æç¬”...</div>
        <div id="character-target-div"></div>
        <div class="controls">
            <button id="retry-btn" class="game-btn btn-retry" onclick="retryChar()">é‡å†™</button>
            <button id="next-btn" class="game-btn btn-next" onclick="nextChar()" disabled>ä¸‹ä¸€å­—</button>
        </div>
    </div>

    <div class="npc-container">
        <div id="npc-bubble" class="speech-bubble">ç¬”å¢¨çº¸ç šå·²å¤‡å¥½ï¼Œå°ä¸»äººè¯·èµæ•™ã€‚</div>
        <div id="npc-avatar" class="npc-avatar">ğŸ‰</div>
    </div>

    <script>
        // =============== å›½é£åœºæ™¯é…ç½® ===============
        const SCENES = [
            { bgClass: 'bg-ink', theme: '#333333', char: 'ğŸ”ï¸', particle: 'none', msgs: { start: 'æ°´å¢¨æ™•æŸ“ï¼Œé™å¿ƒå‡ç¥ã€‚', good: 'ç¬”èµ°é¾™è›‡ï¼Œæ°”éŸµç”ŸåŠ¨ï¼', bad: 'å¢¨è‰²ç¨ä¹±ï¼Œéœ€å†æ²‰ç¨³ã€‚', done: 'å¦™ç¬”ç”ŸèŠ±ï¼Œè‡ªæˆä¸€æ´¾ï¼' } },
            { bgClass: 'bg-festive', theme: '#c0392b', char: 'ğŸŒ¸', particle: 'petals', msgs: { start: 'æ¡ƒä¹‹å¤­å¤­ï¼Œç¼ç¼å…¶åã€‚', good: 'å¦‚èŠ±ç“£é£˜è½èˆ¬è½»ç›ˆï¼', bad: 'ç¬”é”‹æœªåˆ°ï¼ŒèŠ±å„¿éƒ½æ€¥äº†ã€‚', done: 'å­—å¦‚èŠ±å¼€ï¼ŒèŠ¬èŠ³æ»¡çº¸ï¼' } },
            { bgClass: 'bg-nature', theme: '#1b5e20', char: 'ğŸ‹', particle: 'none', msgs: { start: 'èƒ¸æœ‰æˆç«¹ï¼Œæ–¹èƒ½ä¸‹ç¬”ã€‚', good: 'åŠ²èŠ‚æœ‰åŠ›ï¼Œå¦‚ç«¹ä¹‹æŒºæ‹”ï¼', bad: 'æå¶æœªå±•ï¼ŒåŠ›åº¦ä¸å¤Ÿã€‚', done: 'åŠ¿å¦‚ç ´ç«¹ï¼ŒèŠ‚èŠ‚é«˜å‡ï¼' } },
            { bgClass: 'bg-festive', theme: '#d35400', char: 'ğŸ®', particle: 'lanterns', msgs: { start: 'åç¯åˆä¸Šï¼Œæç¬”ç¥ˆç¦ã€‚', good: 'å­—å­—ç ç‘ï¼Œå¦‚æ˜ç¯é—ªçƒï¼', bad: 'ç¯ç«é˜‘çŠï¼Œç¬”ç”»æœªæ˜ã€‚', done: 'ç¦è‡³å¿ƒçµï¼Œå‰ç¨‹ä¼¼é”¦ï¼' } },
            { bgClass: 'bg-purple', theme: '#1a237e', char: 'ğŸº', particle: 'none', msgs: { start: 'ç´ èƒšå‹¾å‹’ï¼Œç¬”é”‹æµ“è½¬æ·¡ã€‚', good: 'å¦‚é’èŠ±ç“·èˆ¬ç²¾è‡´å…¸é›…ï¼', bad: 'é‡‰è‰²æœªåŒ€ï¼Œè¿˜éœ€ç»†ç»†æ‰“ç£¨ã€‚', done: 'ä¼ ä¸–ä½³ä½œï¼Œæ¸©æ¶¦å¦‚ç‰ï¼' } },
            { bgClass: 'bg-nature', theme: '#00796b', char: 'â˜ï¸', particle: 'clouds', msgs: { start: 'äº‘å·äº‘èˆ’ï¼Œè‡ªåœ¨æŒ¥æ´’ã€‚', good: 'è¡Œäº‘æµæ°´ï¼Œç•…é€šæ— é˜»ï¼', bad: 'äº‘é›¾ç¼­ç»•ï¼Œè¿·å¤±æ–¹å‘ã€‚', done: 'å¹³æ­¥é’äº‘ï¼Œç›´ä¸Šä¹éœ„ï¼' } },
            { bgClass: 'bg-festive', theme: '#b71c1c', char: 'ğŸ“œ', particle: 'none', msgs: { start: 'åå¹´å¯’çª—ï¼Œä»Šæœè¯•é”‹ã€‚', good: 'é“ç”»é“¶é’©ï¼ŒåŠ›é€çº¸èƒŒï¼', bad: 'å¢¨è¿¹æœªå¹²ï¼Œåˆ‡å‹¿å¿ƒæ€¥ã€‚', done: 'é‡‘æ¦œé¢˜åï¼Œç‹¬å é³Œå¤´ï¼' } },
            { bgClass: 'bg-ink', theme: '#004d40', char: 'ğŸŒ™', particle: 'petals', msgs: { start: 'æœˆè‰²å…¥æˆ·ï¼Œæç¬”é™æ€ã€‚', good: 'å¦‚æœˆå…‰èˆ¬çšæ´æ— ç‘•ï¼', bad: 'æœˆå½±æœ¦èƒ§ï¼Œç¬”ç”»ä¸æ¸…ã€‚', done: 'æ¸…é£æ˜æœˆï¼Œå­—å­—æ¸…å¿ƒã€‚' } },
            { bgClass: 'bg-festive', theme: '#e65100', char: 'ğŸ‚', particle: 'petals', msgs: { start: 'ä¸€å¶çŸ¥ç§‹ï¼Œç¬”ä¸‹ç”Ÿé£ã€‚', good: 'è½ç¬”æ½‡æ´’ï¼Œå¦‚ç§‹å¶é™ç¾ï¼', bad: 'è§ç‘Ÿç§‹é£ï¼Œç¬”åŠ›ç¨å¼±ã€‚', done: 'ç¡•æœç´¯ç´¯ï¼Œæ»¡çº¸ä¸°æ”¶ï¼' } },
            { bgClass: 'bg-festive', theme: '#bf360c', char: 'ğŸ”¥', particle: 'lanterns', msgs: { start: 'è–ªç«ç›¸ä¼ ï¼Œç”Ÿç”Ÿä¸æ¯ã€‚', good: 'çƒ­æƒ…ä¼¼ç«ï¼Œç¬”åŠ›åˆšå¥ï¼', bad: 'ç«å€™æœªåˆ°ï¼Œè¿˜éœ€ç£¨ç»ƒã€‚', done: 'ç‚‰ç«çº¯é’ï¼Œç™»å³°é€ æï¼' } },
        ];

        // =============== Canvas ç²’å­ç³»ç»Ÿ ===============
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let currentParticleType = 'none';

        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas); resizeCanvas();

        class Particle {
            constructor(type) { this.type = type; this.reset(); }
            reset() {
                this.x = Math.random() * canvas.width;
                this.y = this.type === 'lanterns' ? canvas.height + Math.random() * 100 : -Math.random() * 100;
                this.size = Math.random() * 5 + 3;
                this.speedX = Math.random() * 2 - 1;
                this.speedY = this.type === 'lanterns' ? -Math.random() * 1 - 0.5 : Math.random() * 2 + 1;
                this.opacity = Math.random() * 0.5 + 0.3;
                this.rotation = Math.random() * 360;
                this.rotationSpeed = Math.random() * 2 - 1;
                // é¢œè‰²é…ç½®
                if(this.type === 'petals') this.color = `hsla(${Math.random()*20 + 340}, 70%, 80%, ${this.opacity})`; // ç²‰/çº¢
                else if(this.type === 'lanterns') this.color = `hsla(${Math.random()*30 + 15}, 90%, 60%, ${this.opacity})`; // æ©™/é»„
                else if(this.type === 'clouds') this.color = `hsla(200, 20%, 90%, ${this.opacity * 0.5})`; // ç™½é›¾
            }
            update() {
                this.x += this.speedX; this.y += this.speedY; this.rotation += this.rotationSpeed;
                // è¾¹ç•Œæ£€æŸ¥ä¸é‡ç½®
                if (this.type === 'lanterns') { if (this.y < -50) this.reset(); } 
                else { if (this.y > canvas.height + 50) this.reset(); }
            }
            draw() {
                ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.rotation * Math.PI / 180); ctx.fillStyle = this.color;
                if(this.type === 'lanterns') { // ç”»ç®€æ˜“ç¯ç¬¼
                    ctx.fillRect(-this.size, -this.size*1.5, this.size*2, this.size*3);
                } else { // ç”»åœ†å½¢èŠ±ç“£/äº‘é›¾
                     ctx.beginPath(); ctx.arc(0, 0, this.size, 0, Math.PI * 2); ctx.fill();
                }
                ctx.restore();
            }
        }

        function initParticles(type) {
            currentParticleType = type; particles = [];
            if(type === 'none') return;
            const count = type === 'clouds' ? 30 : 60;
            for (let i = 0; i < count; i++) particles.push(new Particle(type));
        }
        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if(currentParticleType !== 'none') { particles.forEach(p => { p.update(); p.draw(); }); }
            requestAnimationFrame(animateParticles);
        }
        animateParticles();


        // =============== ä¸šåŠ¡é€»è¾‘åŒº ===============
        const API_URL = '/api/handwriting-data';
        let episodes = []; let currentEpisodeData = null; let currentCharIndex = 0; let writer = null; let currentSceneIdx = 0;

        async function init() {
            try {
                const res = await fetch(API_URL); episodes = await res.json();
                const select = document.getElementById('episode-select'); select.innerHTML = '';
                if(episodes.length === 0) { select.innerHTML = '<option>æš‚æ— ä¹¦å·</option>'; return; }
                episodes.forEach((ep, index) => { const opt = document.createElement('option'); opt.value = index; opt.text = ep.title; select.appendChild(opt); });
                currentSceneIdx = 0; // é»˜è®¤æ°´å¢¨å¼€åœº
                document.getElementById('scene-select').value = currentSceneIdx;
                applyScene(currentSceneIdx); loadEpisode(0);
            } catch(e) { console.error(e); }
        }

        function applyScene(idx) {
            currentSceneIdx = idx; const scene = SCENES[idx];
            // 1. åˆ‡æ¢åŠ¨æ€èƒŒæ™¯ class
            const bg = document.getElementById('bg-dynamic');
            bg.className = scene.bgClass;
            // 2. åˆ‡æ¢ç²’å­æ•ˆæœ
            initParticles(scene.particle);
            // 3. æ›´æ–°ä¸»é¢˜è‰²å˜é‡
            document.documentElement.style.setProperty('--theme-color', scene.theme);
            // 4. æ›´æ–°NPC
            const avatar = document.getElementById('npc-avatar'); avatar.innerText = scene.char; 
            avatar.classList.remove('jump-anim'); void avatar.offsetWidth; avatar.classList.add('jump-anim');
            showBubble(scene.msgs.start);
        }

        function manualChangeScene() { const idx = document.getElementById('scene-select').value; applyScene(idx); }
        function changeEpisode() { loadEpisode(document.getElementById('episode-select').value); }
        function loadEpisode(index) { currentEpisodeData = episodes[index]; currentCharIndex = 0; loadCharacter(); }

        function loadCharacter() {
            const scene = SCENES[currentSceneIdx];
            if (!currentEpisodeData || currentCharIndex >= currentEpisodeData.characters.length) { showFinish(); return; }
            const char = currentEpisodeData.characters[currentCharIndex];
            document.getElementById('char-info-display').innerHTML = `
                <span style="font-size:0.8em; opacity:0.8;">ä¹ å­—:</span> ${char} 
                <span style="font-size:0.5em; opacity:0.6;">(${currentCharIndex+1}/${currentEpisodeData.characters.length})</span>
            `;
            document.getElementById('character-target-div').innerHTML = '';
            const nextBtn = document.getElementById('next-btn'); nextBtn.disabled = true; nextBtn.classList.add('btn-disabled');

            // HanziWriter é…ç½® (ä½¿ç”¨æ¯›ç¬”é£æ ¼é¢œè‰²)
            writer = HanziWriter.create('character-target-div', char, {
                width: 300, height: 300, padding: 30, showOutline: true, strokeAnimationSpeed: 1.2, delayBetweenStrokes: 200,
                strokeColor: '#2c2c2c', // è¿‘ä¼¼å¢¨è‰²
                radicalColor: scene.theme, outlineColor: '#aaaaaa', drawingWidth: 28, // ç¬”è§¦æ›´ç²—ï¼Œåƒæ¯›ç¬”
                showHintAfterMisses: 1, highlightOnComplete: true, highlightColor: '#c0392b' // å®Œæˆåæœ±ç ‚çº¢é«˜äº®
            });
            
            writer.quiz({
                onMistake: () => { showBubble(scene.msgs.bad); shakeScreen(); },
                onCorrectStroke: () => { if(Math.random() > 0.7) showBubble(scene.msgs.good); },
                onComplete: () => {
                    showBubble(scene.msgs.done);
                    nextBtn.disabled = false; nextBtn.classList.remove('btn-disabled');
                    const avatar = document.getElementById('npc-avatar'); avatar.classList.remove('jump-anim'); void avatar.offsetWidth; avatar.classList.add('jump-anim');
                    setTimeout(() => writer.animateCharacter(), 500);
                }
            });
        }

        let bubbleTimer;
        function showBubble(text) {
            const bubble = document.getElementById('npc-bubble'); bubble.innerText = text; bubble.classList.add('show');
            clearTimeout(bubbleTimer); bubbleTimer = setTimeout(() => { bubble.classList.remove('show'); }, 3500);
        }
        function shakeScreen() { const stage = document.querySelector('.stage-container'); stage.classList.add('shake-anim'); setTimeout(() => stage.classList.remove('shake-anim'), 500); }
        function retryChar() { showBubble('é™å¿ƒå‡ç¥ï¼Œå†è¯•ä¸€æ¬¡ã€‚'); loadCharacter(); }
        function nextChar() { currentCharIndex++; loadCharacter(); }

        function showFinish() {
            document.getElementById('char-info-display').innerText = "åŠŸå¾·åœ†æ»¡ï¼";
            document.getElementById('character-target-div').innerHTML = `<div style="height:100%; display:flex; justify-content:center; align-items:center; font-size:6em;">ğŸ’®</div>`;
            showBubble('æ­å–œå°ä¸»äººï¼æ­¤å·ä¿®è¡Œå·²å®Œæˆï¼');
        }
        init();
    </script>
</body>
</html>